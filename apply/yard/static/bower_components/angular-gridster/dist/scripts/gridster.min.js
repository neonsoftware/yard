"use strict";angular.module("gridster",[]).controller("GridsterCtrl",function(){function a(b,c){for(var d in c)c[d]&&c[d].constructor&&c[d].constructor===Object?(b[d]=b[d]||{},a(b[d],c[d])):c[d]&&c[d].constructor&&c[d].constructor===Array?(b[d]=b[d]||[],a(b[d],c[d])):b[d]=c[d];return b}return{grid:[],$preview:null,$element:null,opts:{colWidth:"auto",rowHeight:"match",minColumns:1,minRows:1,columns:6,margins:[10,10],defaultSizeX:2,defaultSizeY:1,minGridRows:2,maxGridRows:100,mobileBreakPoint:600,resizable:{enabled:!0},draggable:{enabled:!0}},width:1e3,columns:5,colWidth:"auto",rowHeight:"match",gridHeight:2,maxGridRows:100,margins:[10,10],isMobile:!1,init:function(a,b){this.$element=a,this.$preview=b},setMargins:function(a){this.margins=a},getColumns:function(){return this.columns},getMinColumns:function(){return this.minColumns},getMaxColumns:function(){return this.maxColumns},getMinRows:function(){return this.minRows},getMaxRows:function(){return this.maxRows},setInteger:function(a,b){b&&(b=parseInt(b,10),isNaN(b)||(this[a]=b))},setFloat:function(a,b){b&&(b=parseFloat(b,10),isNaN(b)||(this[a]=b))},setColumns:function(a){this.setInteger("columns",a)},setMinColumns:function(a){this.setInteger("minColumns",a)},setMaxColumns:function(a){this.setInteger("maxColumns",a)},setMinRows:function(a){this.setInteger("minRows",a)},setMaxRows:function(a){this.setInteger("maxRows",a)},setWidth:function(a){this.setFloat("width",a)},setColWidth:function(a){"auto"===a?this.colWidth=(this.width-this.margins[1])/this.columns:this.setFloat("colWidth",a)},setRowHeight:function(a){"match"===a?this.rowHeight=this.colWidth:this.setFloat("rowHeight",a)},setMaxGridRows:function(a){this.setInteger("maxGridRows",a)},getRowHeight:function(){return this.rowHeight},destroy:function(){this.grid&&(this.grid.length=0),this.opts=this.margins=this.grid=this.$element=this.$preview=null},setOpts:function(b){b&&a(this.opts,b),this.opts.margins&&(this.margins=this.opts.margins),this.opts.columns&&this.setColumns(this.opts.columns),this.opts.minColumns&&this.setMinColumns(this.opts.minColumns),this.opts.maxColumns&&this.setMaxColumns(this.opts.maxColumns),this.opts.minRows&&this.setMinRows(this.opts.minRows),this.opts.maxRows&&this.setMaxRows(this.opts.maxRows),this.opts.width?this.setWidth(this.opts.width):this.$element&&this.setWidth(this.$element.width()),this.opts.colWidth&&this.setColWidth(this.opts.colWidth),this.opts.rowHeight&&this.setRowHeight(this.opts.rowHeight),this.opts.maxGridRows&&this.setMaxGridRows(this.opts.maxGridRows)},redraw:function(){this.setOpts(),this.isMobile=this.width<=this.opts.mobileBreakPoint;for(var a=0,b=this.grid.length;b>a;++a){var c=this.grid[a];if(c)for(var d=0,e=c.length;e>d;++d)if(c[d]){var f=c[d],g=f.$element;this.setElementPosition(g,f.row,f.col),this.setElementSizeY(g,f.sizeY),this.setElementSizeX(g,f.sizeX)}}},canItemOccupy:function(a,b,c){return b>-1&&c>-1&&a.sizeX+c<=this.columns},autoSetItemPosition:function(a){for(var b=0;b<this.maxGridRows;++b)for(var c=0;c<this.columns;++c){var d=this.getItem(b,c),e=this.canItemOccupy(a,b,c);if(!d&&e)return this.putItem(a,b,c),void 0}throw new Error("Unable to place item!")},getItems:function(a,b,c,d,e){var f=[];c&&d||(c=d=1),!e||e instanceof Array||(e=[e]);for(var g=0;d>g;++g)for(var h=0;c>h;++h){var i=this.getItem(a+g,b+h,e);!i||e&&-1!==e.indexOf(i)||-1!==f.indexOf(i)||f.push(i)}return f},removeItem:function(a){for(var b=0,c=this.grid.length;c>b;++b){var d=this.grid[b];if(d){var e=d.indexOf(a);if(-1!==e){d[e]=null;break}}}this.floatItemsUp(),updateHeight()},getItem:function(a,b,c){!c||c instanceof Array||(c=[c]);for(var d=1;a>-1;){for(var e=1,f=b;f>-1;){var g=this.grid[a];if(g){var h=g[f];if(h&&(!c||-1===c.indexOf(h))&&h.sizeX>=e&&h.sizeY>=d)return h}++e,--f}--a,++d}return null},putItems:function(a){for(var b=0,c=a.length;c>b;++b)this.putItem(a[b])},putItem:function(a,b,c){if(("undefined"==typeof b||null===b)&&(b=a.row,c=a.col,"undefined"==typeof b||null===b))return this.autoSetItemPosition(a),void 0;if(this.canItemOccupy(a,b,c)||(c=Math.min(this.columns-a.sizeX,Math.max(0,c)),b=Math.max(0,b)),a&&null!==a.oldRow&&"undefined"!=typeof a.oldRow){if(a.oldRow===b&&a.oldColumn===c)return a.row=b,a.col=c,void 0;var d=this.grid[a.oldRow];d&&d[a.oldColumn]===a&&delete d[a.oldColumn]}a.oldRow=a.row=b,a.oldColumn=a.col=c,this.moveOverlappingItems(a),this.grid[b]||(this.grid[b]=[]),this.grid[b][c]=a},moveOverlappingItems:function(a){var b=this.getItems(a.row,a.col,a.sizeX,a.sizeY,a);this.moveItemsDown(b,a.row+a.sizeY)},moveItemsDown:function(a,b){if(a&&0!==a.length){var c,d,e,f={};for(d=0,e=a.length;e>d;++d){c=a[d];var g=f[c.col];("undefined"==typeof g||c.row<g)&&(f[c.col]=c.row)}for(d=0,e=a.length;e>d;++d){c=a[d];var h=b-f[c.col];this.putItem(c,c.row+h,c.col)}}},floatItemsUp:function(){for(var a=0,b=this.grid.length;b>a;++a){var c=this.grid[a];if(c)for(var d=0,e=c.length;e>d;++d)c[d]&&this.floatItemUp(c[d])}},floatItemUp:function(a){for(var b=a.col,c=a.sizeY,d=a.sizeX,e=null,f=null,g=a.row-1;g>-1;){var h=this.getItems(g,b,d,c,a);if(0!==h.length)break;e=g,f=b,--g}null!==e&&this.putItem(a,e,f)},updateHeight:function(a){var b=this.opts.minGridRows;a||(a=0);for(var c=this.grid.length;c>=0;--c){var d=this.grid[c];if(d)for(var e=0,f=d.length;f>e;++e)d[e]&&(b=Math.max(b,c+a+d[e].sizeY))}this.gridHeight=Math.min(this.maxGridRows,b)},pixelsToRows:function(a,b){return b===!0?Math.ceil(a/this.rowHeight):b===!1?Math.floor(a/this.rowHeight):Math.round(a/this.rowHeight)},pixelsToColumns:function(a,b){return b===!0?Math.ceil(a/this.colWidth):b===!1?Math.floor(a/this.colWidth):Math.round(a/this.colWidth)},setElementPosition:function(a,b,c){this.isMobile?a.css({margin:this.margins[0]+"px",top:"auto",left:"auto"}):a.css({margin:0,top:b*this.rowHeight+this.margins[0],left:c*this.colWidth+this.margins[1]})},setElementSizeY:function(a,b){this.isMobile?a.css("height","auto"):a.css("height",b*this.rowHeight-this.margins[0]+"px")},setElementSizeX:function(a,b){this.isMobile?a.css("width","auto"):a.css("width",b*this.colWidth-this.margins[1]+"px")}}}).directive("gridster",["$parse","$timeout",function(a,b){return{restrict:"EAC",controller:"GridsterCtrl",compile:function(){return{pre:function(b,c,d,e){function f(){e.$element.css("height",e.gridHeight*e.rowHeight+e.margins[0]+"px")}var g=d.gridster,h={};if(g){var i=a(g);h=i(b),b.$watch(g,function(a,c){a!==c&&(e.setOpts(a),"undefined"!=typeof a.draggable&&"undefined"!=typeof c.draggable&&a.draggable!==c.draggable&&b.$broadcast("draggable-changed",a.draggable),"undefined"!=typeof a.resizable&&"undefined"!=typeof c.resizable&&a.resizable!==c.resizable&&b.$broadcast("resizable-changed",a.resizable),e.redraw(),f())},!0)}e.setOpts(h)},post:function(a,c,d,e){function f(){e.$element.css("height",e.gridHeight*e.rowHeight+e.margins[0]+"px")}function g(){var b=c.width();b===i||c.find(".gridster-item-moving").length>0||(i=b,c.removeClass("gridster-loaded"),e.redraw(),f(),a.$broadcast("gridster-resized",[b,c.height()]),c.addClass("gridster-loaded"))}c.addClass("gridster"),c.removeClass("gridster-loaded");var h=angular.element('<div class="gridster-item gridster-preview-holder"></div>').appendTo(c);a.$watch(function(){return e.gridHeight},f),a.$watch(function(){return e.isMobile},function(a){a?e.$element.addClass("gridster-mobile"):e.$element.removeClass("gridster-mobile")});var i=c.width();angular.element(window).on("resize",function(){g(),a.$apply()}),a.$watch(function(){return c.width()},g),c.bind("$destroy",function(){try{this.$preview.remove(),e.destroy()}catch(a){}}),e.init(c,h),e.redraw(),b(function(){e.floatItemsUp(),c.addClass("gridster-loaded")},100)}}}}}]).controller("GridsterItemCtrl",function(){return{$element:null,gridster:null,dragging:!1,resizing:!1,row:null,col:null,sizeX:null,sizeY:null,init:function(a,b){this.$element=a,this.gridster=b,this.sizeX=b.opts.defaultSizeX,this.sizeY=b.opts.defaultSizeY},destroy:function(){this.gridster=null,this.$element=null},toJSON:function(){return{row:this.row,col:this.col,sizeY:this.sizeY,sizeX:this.sizeX}},setPosition:function(a,b){this.gridster.putItem(this,a,b),this.gridster.floatItemsUp(),this.gridster.updateHeight(this.dragging?this.sizeY:0),this.dragging?this.gridster.setElementPosition(this.gridster.$preview,this.row,this.col):this.gridster.setElementPosition(this.$element,this.row,this.col)},setSize:function(a,b){a=a.toUpperCase();var c="size"+a,d="Size"+a;if(""!==b){b=parseInt(b,10),(isNaN(b)||0===b)&&(b=this.gridster.opts["default"+d]);var e=!(this[c]===b&&this["old"+d]&&this["old"+d]===b);this["old"+d]=this[c]=b,this.resizing?(this.gridster.setElementPosition(this.gridster.$preview,this.row,this.col),this.gridster["setElement"+d](this.gridster.$preview,b)):this.gridster["setElement"+d](this.$element,b),e&&(this.gridster.moveOverlappingItems(this),this.gridster.floatItemsUp(),this.gridster.updateHeight(this.dragging?this.sizeY:0))}},setSizeY:function(a){this.setSize("y",a)},setSizeX:function(a){this.setSize("x",a)}}}).directive("gridsterItem",["$parse","$controller","$timeout",function(a,b,c){return{restrict:"EAC",require:"^gridster",link:function(d,e,f,g){function h(a){if(o)if(a)e.draggable({handle:g.opts.draggable&&g.opts.draggable.handle?g.opts.draggable.handle:null,refreshPositions:!0,start:function(a,b){e.addClass("gridster-item-moving"),n.dragging=!0,g.$preview.show(),g.setElementSizeX(g.$preview,n.sizeX),g.setElementSizeY(g.$preview,n.sizeY),g.setElementPosition(g.$preview,n.row,n.col),g.updateHeight(n.sizeY),d.$apply(),g.opts.draggable&&g.opts.draggable.start&&(g.opts.draggable.start(a,b,e),d.$apply())},drag:function(a,b){n.row=g.pixelsToRows(b.position.top),n.col=g.pixelsToColumns(b.position.left),d.$apply(),g.opts.draggable&&g.opts.draggable.drag&&(g.opts.draggable.drag(a,b,e),d.$apply())},stop:function(a,b){e.removeClass("gridster-item-moving"),n.row=g.pixelsToRows(b.position.top),n.col=g.pixelsToColumns(b.position.left),n.dragging=!1,g.$preview.hide(),n.setPosition(n.row,n.col),g.updateHeight(),d.$apply(),g.opts.draggable&&g.opts.draggable.stop&&(g.opts.draggable.stop(a,b,e),d.$apply())}});else try{e.draggable("destroy")}catch(b){}}function i(a){p&&a&&(e.resizable("option","minHeight",(g.minRows?g.minRows:1)*g.rowHeight-g.margins[0]),e.resizable("option","maxHeight",(g.maxRows?g.maxRows:g.maxGridRows)*g.rowHeight-g.margins[0]),e.resizable("option","minWidth",(g.minColumns?g.minColumns:1)*g.colWidth-g.margins[1]),e.resizable("option","maxWidth",(g.maxColumns?g.maxColumns:g.columns)*g.colWidth-g.margins[1]))}function j(a){if(p)if(a)e.resizable({autoHide:!0,handles:"n, e, s, w, ne, se, sw, nw",minHeight:(g.minRows?g.minRows:1)*g.rowHeight-g.margins[0],maxHeight:(g.maxRows?g.maxRows:g.maxGridRows)*g.rowHeight-g.margins[0],minWidth:(g.minColumns?g.minColumns:1)*g.colWidth-g.margins[1],maxWidth:(g.maxColumns?g.maxColumns:g.columns)*g.colWidth-g.margins[1],start:function(a,b){e.addClass("gridster-item-moving"),n.resizing=!0,n.dragging=!0,g.$preview.fadeIn(300),g.setElementSizeX(g.$preview,n.sizeX),g.setElementSizeY(g.$preview,n.sizeY),d.$apply(),g.opts.resize&&g.opts.resize.start&&(g.opts.resize.start(a,b,e),d.$apply())},resize:function(a,b){n.row=g.pixelsToRows(b.position.top,!1),n.col=g.pixelsToColumns(b.position.left,!1),n.sizeX=g.pixelsToColumns(b.size.width,!0),n.sizeY=g.pixelsToRows(b.size.height,!0),d.$apply(),g.opts.resize&&g.opts.resize.resize&&(g.opts.resize.resize(a,b,e),d.$apply())},stop:function(a,b){e.removeClass("gridster-item-moving"),n.row=g.pixelsToRows(b.position.top,!1),n.col=g.pixelsToColumns(b.position.left,!1),n.sizeX=g.pixelsToColumns(b.size.width,!0),n.sizeY=g.pixelsToRows(b.size.height,!0),n.resizing=!1,n.dragging=!1,g.$preview.fadeOut(300),n.setPosition(n.row,n.col),n.setSizeY(n.sizeY),n.setSizeX(n.sizeX),d.$apply(),g.opts.resize&&g.opts.resize.stop&&(g.opts.resize.stop(a,b,e),d.$apply())}});else try{e.resizable("destroy")}catch(b){}}function k(){n.setPosition(n.row,n.col),s.row&&s.row.assign&&s.row.assign(d,n.row),s.col&&s.col.assign&&s.col.assign(d,n.col)}var l,m=f.gridsterItem,n=b("GridsterItemCtrl"),o="function"==typeof e.draggable,p="function"==typeof e.resizable;if(m){var q=a(m);l=q(d)||{},!l&&q.assign&&(l={row:n.row,col:n.col,sizeX:n.sizeX,sizeY:n.sizeY},q.assign(d,l))}else l=f;n.init(e,g),e.addClass("gridster-item"),e.addClass("gridster-item-moving");for(var r=["sizeX","sizeY","row","col"],s={},t=0,u=r.length;u>t;++t)!function(b){var c;if("string"==typeof l[b])c=l[b];else if("string"==typeof l[b.toLowerCase()])c=l[b.toLowerCase()];else{if(!m)return;c=a(m+"."+b)}s[b]=a(c),d.$watch(c,function(a){a=parseInt(a,10),isNaN(a)||(n[b]=a)});var e=s[b](d);"number"==typeof e&&(n[b]=e)}(r[t]);return d.$watch(function(){return n.row},k),d.$watch(function(){return n.col},k),d.$on("draggable-changed",function(a,b){h(b.enabled)}),d.$on("resizable-changed",function(a,b){j(b.enabled)}),d.$on("gridster-resized",function(){i("undefined"!=typeof g.opts.resizable&&"undefined"!=typeof g.opts.resizable.enabled&&g.opts.resizable.enabled)}),h("undefined"!=typeof g.opts.draggable&&"undefined"!=typeof g.opts.draggable.enabled&&g.opts.draggable.enabled),j("undefined"!=typeof g.opts.resizable&&"undefined"!=typeof g.opts.resizable.enabled&&g.opts.resizable.enabled),d.$watch(function(){return n.sizeY},function(a){n.setSizeY(a),s.sizeY&&s.sizeY.assign&&s.sizeY.assign(d,n.sizeY)}),d.$watch(function(){return n.sizeX},function(a){n.setSizeX(a),s.sizeX&&s.sizeX.assign&&s.sizeX.assign(d,n.sizeX)}),c(function(){e.removeClass("gridster-item-moving")},100),e.bind("$destroy",function(){try{g.removeItem(n)}catch(a){}try{n.destroy()}catch(a){}try{e.draggable("destroy")}catch(a){}try{e.resizable("destroy")}catch(a){}})}}}]);