<dom-module id="blocks-detail">

  <template>
    <iron-ajax id="my_iron_elem" method="GET" handle-as="json" on-response="_handle_response_get"></iron-ajax>
    <iron-ajax id="my_iron_save" method="PUT" handle-as="json" on-response="_handle_response_post"></iron-ajax>

    <paper-material elevation="1">
      <span style="font-size: 12px;color: grey; ">Language</span>
      <br>
      <paper-input type="text" value="{{currentitem.language}}" ></paper-input>
      <br><br>
      <span style="font-size: 12px;color: grey; ">Tags</span>
      <br>
      <paper-input type="text" value="{{currentitem.tags}}" ></paper-input>
      <br><br>
      <span style="font-size: 12px;color: grey; ">Text (use AAA, BBB, etc..)</span>
      <br>
      <iron-autogrow-textarea bind-value="{{currentcontent}}">
        <textarea></textarea>
      </iron-autogrow-textarea>
      <br><br>
      <template is="dom-repeat" items="{{currentlegend}}">
        <i>Describe<span>{{item.key}}</span></i> &nbsp;&nbsp;
        <paper-input type="text" value="{{item.value}}" ></paper-input><br>
      </template>

      <paper-button on-click="save_me">save</paper-button>
    </paper-material>

  </template>

</dom-module>

<script>
  (function () {
    Polymer({

      is: 'blocks-detail',
      properties: {
        is_new: Boolean,
        currentitem: {
          type: Object,
          value: {"language":"en",
                  "tags":"",
                  "content": "",
                  "legend": ""
                  }
        },
        currentcontent: {
          type: String,
          observer: '_on_content_change',
          value: ""
        },
        currentlegend: {
          type: Array,
          value: []
        },
        currentlegendObject: {
          type: Object,
          value: {}
        },
        objid: {
          type: Number,
          observer:'_obj_id_has_changed'
        },
        lettersymbols: {
          type: Array,
          value: ['AAA', 'BBB', 'CCC', 'DDD', 'EEE', 'FFF', 'GGG', 'HHH', 'III', 'JJJ', 'KKK', 'LLL', 'MMM', 'NNN', 'OOO', 'PPP', 'QQQ', 'RRR', 'SSS', 'TTT', 'UUU', 'WWW', 'XXX', 'YYY', 'ZZZ']
        }
      },

      ready:function(){
        console.log('Ready. Initializing symbols.');
        console.log('Checking also  ', this.objid, this.lettersymbols);

      },
      attached:function(){
        console.log('Attached. Initializing symbols.');
        console.log('Checking also  ', this.objid, this.lettersymbols);

      },

      refresh_me: function(){
        this.$.my_iron_elem.url = "/pieces/" + String(this.objid);
        this.$.my_iron_elem.generateRequest();
      },

      save_me: function(){
        this.currentitem.content = this.currentcontent;
        this.currentitem.legend = [];
        for (index = 0, len = this.currentlegend.length; index < len; ++index) {
          for( var key in this.currentlegend[index] ){
            this.currentitem.legend[key] = this.currentlegend[index][key];
            console.log("AAAdding to current item legend !! ", currentSymbol);

          }
          console.log("AAAdding it ! ", currentSymbol);
        }

        if( this.is_new ){
          console.log('Saving new object. POST');
          this.$.my_iron_save.url = "/pieces" ;
          this.$.my_iron_save.method = "POST"
        }else {
          console.log('Updating object. PUT');
          this.$.my_iron_save.url = "/pieces/" + String(this.objid) + '/';
          this.$.my_iron_save.method = "PUT"
        }
        this.$.my_iron_save.body = JSON.stringify(this.currentitem);
        this.$.my_iron_save.contentType = "application/json";
        this.$.my_iron_save.generateRequest();
      },

      _handle_response_get: function(response){
        console.log('Received response from GET: ', response.detail.response);
        this.currentitem = response.detail.response;
        this.currentcontent = response.detail.response.content;
      },

      _handle_response_post: function(response){
        console.log('Received response from POST: ', response.detail.response);
        this.currentitem = response.detail.response;
        this.currentcontent = response.detail.response.content;
      },

      _obj_id_has_changed: function(new_value, old_value){
        this.is_new = ( new_value === "new" );
        console.log("Is new : ", this.is_new);
        if (!this.is_new){
          this.refresh_me();
        }
      },

      _on_content_change: function(new_value, old_value){

        var new_legendObject = {};

        if (typeof this.lettersymbols != 'undefined' && typeof this.currentlegendObject != 'undefined'){
          console.log('Content updated. Before: ', old_value, ', After: ', new_value);
          console.log('Checking also  ', this.objid, this.lettersymbols);

          var index, len;
          for (index = 0, len = this.lettersymbols.length; index < len; ++index) {
            var currentSymbol = this.lettersymbols[index];
            //console.log("Checking ", currentSymbol);
            if ( new_value.indexOf(currentSymbol) >-1 ){
              console.log("FOOOOOOOUNDDDDDD ", currentSymbol);
              if( currentSymbol in this.currentlegendObject ){
                console.log("WWWWWAAASSSSS present ! ", currentSymbol);
                new_legendObject[currentSymbol] = this.currentlegendObject[currentSymbol];
              }else{
                console.log("AAAdding it ! ", currentSymbol);
                new_legendObject[currentSymbol] = "";
              }
            }
          }

          console.log("New legend : ", new_legendObject);

          if( JSON.stringify(this.currentlegendObject) != JSON.stringify(new_legendObject) ){
            console.log("Updating current.");
            this.currentlegendObject = new_legendObject;
            var new_legendList = [];
            for( var key in new_legendObject ){
              if( new_legendObject.hasOwnProperty(key) ){
                console.log("Adding to list :", key);
                new_legendList.push({"key": new_legendObject[key]});
              }
            }
            this.currentlegend = new_legendList;
          }


        }


      }

    });
  })();
</script>
