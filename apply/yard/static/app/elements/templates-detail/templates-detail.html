<dom-module id="templates-detail">

  <style>
    paper-button[raised].colorful {
      background: #4285f4;
      color: #fff;
      @apply(--layout-vertical --layout-center-center);
    }

    [card] {
      width: 600px;
      margin: 16px auto;
      padding: 16px;
      @apply(--layout-vertical --layout-center-center);
    }

    [centerButton] {
      text-align: center;
      padding: 16px;
    }
  </style>


  <template>
    <iron-ajax id="my_iron_get" auto method="GET" url="{{computeGetUrl(objid)}}" handle-as="json" content-type="application/json" on-response="_handle_response_get"></iron-ajax>
    <iron-ajax id="my_iron_save" method="{{computePushMethod(objid)}}" url="{{computePushUrl(objid)}}" handle-as="json" content-type="application/json" on-response="_handle_response_post"></iron-ajax>

    <paper-material card elevation="1">
      <paper-input type="text" label="Description" floatingLabel value="{{currentitem.description}}"></paper-input>
      <paper-input type="text" label="Language" floatingLabel value="{{currentitem.language}}"></paper-input>
      <paper-input type="text" label="Tags" floatingLabel value="{{currentitem.tags}}" ></paper-input>
      <br><br>
      <template is="dom-repeat" items="{{currentpieces}}">
        <paper-material elevation="2">
        <span>{{item.content}}</span>
        <paper-button tabindex="0" raised class="colorful" on-click="move_up">^</paper-button>
        <paper-button tabindex="0" raised class="colorful" on-click="move_down">v</paper-button>
        </paper-material>
      </template>

      <div centerButton>
          <paper-button tabindex="0" raised class="colorful" on-click="save_me">save</paper-button>
      </div>
    </paper-material>

  </template>

</dom-module>

<script>
  (function () {
    Polymer({

      is: 'templates-detail',
      properties: {
        debug: {
          type: Boolean,
          value: false
        },
        currentitem: {
          type: Object,
          value: {"description":"",
                  "language":"en",
                  "tags":"",
                  "pieces":""
                  }
        },
        objid: {
          type: Number,
          observer:'_obj_id_has_changed'
        },
      },

      save_me: function(){
        this.currentitem.pieces = JSON.stringify(this.currentpieces);
        console.log("In the end pieces is : ", this.currentitem.pieces );
        this.$.my_iron_save.body = JSON.stringify(this.currentitem);
        console.log("Payload is  : ", JSON.stringify(this.currentitem) );
        this.$.my_iron_save.generateRequest();
      },

      _handle_response_get: function(response){
        if ( typeof this.objid != 'undefined' && typeof response.detail.response != 'undefined'){
          console.log('Received response from GET: ', response.detail.response);
          this.currentitem = response.detail.response;
          this.currentpieces = JSON.parse(response.detail.response.pieces);
          console.log('The pieces from the GET is :', this.currentpieces );
        }
      },

      _handle_response_post: function(response){
        console.log('Received response from POST: ', response.detail.response);
        this.currentitem = response.detail.response;
        this.currentcontent = response.detail.response.content;
        this.currentlegend = JSON.parse(response.detail.response.legend);
        console.log('The legend got from the POST is :', this.currentlegend );
      },

      _obj_id_has_changed: function(new_value, old_value){
        console.log('ON CHANGE :  ', new_value);
        if ( new_value !== "new" ){
            this.$.my_iron_get.generateRequest();
        }
      },

      computeKey:function(currentv){
        return 'Describe ' + currentv ;
      },

      computeGetUrl:function(currentId){
        var new_get_url = ( currentId === "new" ) ? '' : '/categories/' + String(this.objid);
        console.log('Computing GET URL :', new_get_url );
        return new_get_url;
      },

      computePushMethod:function(currentId){
        var new_push_method = ( currentId === "new" ) ? "POST" : "PUT";
        console.log('Computing Push method :', new_push_method );
        return new_push_method;
      },

      computePushUrl:function(currentId){
        var new_push_url = ( currentId === "new" ) ? '/categories' : '/categories/' + currentId + '/';
        console.log('Computing Push URL :', new_push_url );
        return new_push_url;
      },

      move_up: function(e) {
        console.log('moving up ');
        var model = e.model;
        var id = model.item.id;
        console.log('moving up ', id);

        var newCurrentPieces = [];

        for (index = 0, len = this.currentpieces.length; index < len; ++index) {
          var currentItem = this.currentpieces[index];
          console.log('Iter ', index, ' - item ', currentItem);
          if( index + 1 < len){
            if ( this.currentpieces[index+1].id === id ){
              newCurrentPieces.push(this.currentpieces[index+1]);
              index++;
            }
          }
          newCurrentPieces.push(currentItem);
        }

        this.currentpieces = newCurrentPieces;
      },

      move_down: function(e) {
        console.log('moving down ');
        var model = e.model;
        var id = model.item.id;
        console.log('moving down ', id);

        var newCurrentPieces = [];

        for (index = 0, len = this.currentpieces.length; index < len; ++index) {
          var currentItem = this.currentpieces[index];
          console.log('Iter ', index, ' - item ', currentItem);
          if ( currentItem.id === id && index + 1 < len ){
              console.log('It is NOT the last one !! ');
              newCurrentPieces.push(this.currentpieces[index+1]);
              ++index;
          }
          newCurrentPieces.push(currentItem);
        }

        this.currentpieces = newCurrentPieces;
      },

    });
  })();
</script>
