<dom-module id="templates-detail">

  <style>
    paper-button[raised].colorful {
      background: #4285f4;
      color: #fff;
      @apply(--layout-vertical --layout-center-center);
    }

    [card] {
      width: 600px;
      margin: 16px auto;
      padding: 16px;
      @apply(--layout-vertical --layout-center-center);
    }

    [centerButton] {
      text-align: center;
      padding: 16px;
    }
  </style>


  <template>
    <iron-ajax id="my_iron_get" auto method="GET" url="{{getURL}}" handle-as="json" content-type="application/json" on-response="_handle_response_get"></iron-ajax>
    <iron-ajax id="my_iron_get_template" auto method="GET" url="{{templategetURL}}" handle-as="json" content-type="application/json" on-response="_handle_response_get_template"></iron-ajax>
    <iron-ajax id="my_iron_save" method="{{pushmethod}}" url="{{pushURL}}" handle-as="json" content-type="application/json" on-response="_handle_response_post"></iron-ajax>

    <paper-material card elevation="1">
      <paper-input type="text" label="Title" floatingLabel value="{{currentitem.name}}"></paper-input>
      <paper-input type="text" label="Description" floatingLabel value="{{currentitem.description}}"></paper-input>
      <paper-input type="text" label="Language" floatingLabel value="{{currentitem.language}}"></paper-input>
      <paper-input type="text" label="Tags" floatingLabel value="{{currentitem.tags}}" ></paper-input>
      <br><br>
      <template is="dom-repeat" items="{{currentpieces}}">
        <paper-material elevation="2">
        <span>{{item.content}}</span>
        <paper-button tabindex="0" raised class="colorful" on-click="move_up">^</paper-button>
        <paper-button tabindex="0" raised class="colorful" on-click="move_down">v</paper-button>
        </paper-material>
      </template>

      <span >no tag</span>
      <paper-checkbox checked="{{isnotabselected}}"></paper-checkbox><br>
      <template is="dom-repeat" items="{{tags}}">
        <span >{{item.name}}</span>
        <paper-checkbox checked="{{item.selected}}"></paper-checkbox><br>
      </template>

      <div centerButton>
          <paper-button tabindex="0" raised class="colorful" on-click="save_me">save</paper-button>
      </div>
    </paper-material>

  </template>

</dom-module>

<script>
  (function () {
    Polymer({

      is: 'templates-detail',
      properties: {
        debug: {
          type: Boolean,
          value: false
        },
        currentitem: {
          type: Object,
          value: {"name":"","description":"",
                  "language":"en",
                  "tags":"",
                  "pieces":""
                  }
        },
        objid: Number,
        getURL: String,
        pushmethod: String,
        pushURL: String,
        templateserverurl: String,
        serverurl: String,
        isnotabselected: Boolean,
        tags: Array,
        blocks: Array,
        selectedblocks: Array
      },

      observers:['updateAjaxParameters(objid, serverurl, templateserverurl)',
                  'updateTags(tags.*, isnotabselected, blocks)'],

      save_me: function(){
        this.currentitem.pieces = JSON.stringify(this.currentpieces);
        console.log("templates-detail :In the end pieces is : ", this.currentitem.pieces );
        this.$.my_iron_save.body = JSON.stringify(this.currentitem);
        console.log("templates-detail :Payload is  : ", JSON.stringify(this.currentitem) );
        this.$.my_iron_save.generateRequest();
      },

      _handle_response_get: function(response){
        if ( typeof this.objid != 'undefined' && this.objid != 'new' && typeof response.detail.response != 'undefined'){
          console.log('templates-detail :Received response from GET: ', response.detail.response);
          this.currentitem = response.detail.response;
          this.currentpieces = JSON.parse(response.detail.response.pieces);
          console.log('templates-detail :The pieces from the GET is :', this.currentpieces );
        }
      },

      _handle_response_get_template: function(response){
        var i, len;
        var newTags = [];
        if ( typeof this.templategetURL != '' && typeof response.detail.response != 'undefined' && response.detail.response != null){
          console.log('templates-detail :Received response from GET TEMPLATE: ', response.detail.response);
          this.blocks = response.detail.response;
          for (index = 0, len = this.blocks.length; index < len; ++index) {
            var currentItem = this.blocks[index];
            console.log('templates-detail :Iter ', index, ' - item ', currentItem);
            if( currentItem.tags.length > 0){
              newTags.push({name: currentItem.tags, selected: false});
            }
          }
        }
        this.isnotabselected = false;
        this.tags = newTags;
        console.log('templates-detail :Done TAGS : ', this.tags);
      },

      _handle_response_post:function(response){
        console.log('templates-detail :Received response from POST: ', response.detail.response);
        window.location = '#!/templates';
        window.location.reload();
      },

      updateAjaxParameters: function(current_id, current_serverurl, current_template_server){
        console.log('templates-detail : Now AJAX');
        var isNew = Boolean(current_id === "new");;
        this.getURL = ( isNew ) ? '' : current_serverurl + '/' + String(this.objid) + '/';
        this.pushmethod = ( isNew ) ? "POST" : "PUT";
        this.pushURL = ( isNew ) ? current_serverurl : current_serverurl + '/' + String(this.objid) ;
        this.templategetURL = ( isNew ) ? this.templateserverurl : '';
        if(this.debug) console.log('templates-detail :Computed - getURL :', this.getURL, ' - pushmethod :', this.pushmethod, ' - pushURL :', this.pushURL, ' - templategetURL :', this.templateserverurl );
      },

      updateTags: function(current_tags, isnotabselected, current_blocks){
        var newCurrentPieces = []

        if(this.debug) console.log('TAGS HAVE CHANGED');
        var activeTags = [];
        for (index = 0, len = this.tags.length; index < len; ++index) {
          var currenttag = this.tags[index];
          console.log('templates-detail :Iter ', index, ' - currenttag ', currenttag);
          if( currenttag.selected ){
            activeTags.push(currenttag.name);
          }
        }

        for (index = 0, len = this.blocks.length; index < len; ++index) {
          var currentblock = this.blocks[index];
          console.log('templates-detail :Iter ', index, ' - currentblock ', currentblock);

          if( (currentblock.tags.length == 0 && this.isnotabselected) || (activeTags.indexOf(currentblock.tags) >-1) ){
            newCurrentPieces.push(currentblock);
          }
        }

        this.currentpieces = newCurrentPieces;
      },

      move_up: function(e) {
        var model = e.model;
        var id = model.item.id;
        var newCurrentPieces = [];
        console.log('templates-detail :moving up ', id);

        for (index = 0, len = this.currentpieces.length; index < len; ++index) {
          var currentItem = this.currentpieces[index];
          console.log('templates-detail :Iter ', index, ' - item ', currentItem);
          if( index + 1 < len){
            if ( this.currentpieces[index+1].id === id ){
              newCurrentPieces.push(this.currentpieces[index+1]);
              index++;
            }
          }
          newCurrentPieces.push(currentItem);
        }

        this.currentpieces = newCurrentPieces;
      },

      move_down: function(e) {
        var model = e.model;
        var id = model.item.id;
        var newCurrentPieces = [];
        console.log('templates-detail :moving down ', id);

        for (index = 0, len = this.currentpieces.length; index < len; ++index) {
          var currentItem = this.currentpieces[index];
          console.log('templates-detail :Iter ', index, ' - item ', currentItem);
          if ( currentItem.id === id && index + 1 < len ){
              console.log('templates-detail :It is NOT the last one !! ');
              newCurrentPieces.push(this.currentpieces[index+1]);
              ++index;
          }
          newCurrentPieces.push(currentItem);
        }
        this.currentpieces = newCurrentPieces;
      },

    });
  })();
</script>
