<dom-module id="covers-detail">

  <style>
    paper-button[raised].colorful {
      background: #4285f4;
      color: #fff;
      @apply(--layout-vertical --layout-center-center);
    }

    [card] {
      width: 600px;
      margin: 16px auto;
      padding: 16px;
      @apply(--layout-vertical --layout-center-center);
    }

    [centerButton] {
      text-align: center;
      padding: 16px;
    }
  </style>


  <template>
    <iron-ajax id="my_iron_get" method="GET" url="{{computeGetUrl(objid)}}" handle-as="json" content-type="application/json" on-response="_handle_response_get"></iron-ajax>
    <iron-ajax id="my_iron_get_template" method="GET" url="{{computeGetUrlOfTemplate(objtempl)}}" handle-as="json" content-type="application/json" on-response="_handle_response_get_template"></iron-ajax>
    <iron-ajax id="my_iron_save" method="{{computePushMethod(objid)}}" url="{{computePushUrl(objid)}}" handle-as="json" content-type="application/json" on-response="_handle_response_post"></iron-ajax>

    <paper-material card elevation="1">
      <paper-input type="text" label="Name" floatingLabel value="{{currentitem.name}}"></paper-input>
      <br>
      <iron-autogrow-textarea bind-value="{{currentcontent}}">
        <textarea></textarea>
      </iron-autogrow-textarea>
      <br><br>
      Legend : <span>{{currentlegend}}</span><br>

      <template is="dom-repeat" items="{{currentlegend}}">
        Item :<span>{{item}}</span>
        Key : <span>{{item.key}}</span> Value  : <span>{{item.value}}</span>
        <paper-input type="text" label="{{computeKey(item.key)}}" floatingLabel value="{{item.value}}" ></paper-input><br>
      </template>

      <div centerButton>
          <paper-button tabindex="0" raised class="colorful" on-click="save_me">save</paper-button>
      </div>
    </paper-material>

  </template>

</dom-module>

<script>
  (function () {
    Polymer({

      is: 'covers-detail',
      properties: {
        debug: {
          type: Boolean,
          value: false
        },
        objid: {
          type: Number,
          observer:'_obj_id_has_changed'
        },
        objtempl: {
          type: Number,
          observer:'_obj_templ_has_changed'
        }
      },

      ready: function(){
        this.lettersymbols = ['AAA', 'BBB', 'CCC', 'DDD', 'EEE', 'FFF', 'GGG', 'HHH', 'III', 'JJJ', 'KKK', 'LLL', 'MMM', 'NNN', 'OOO', 'PPP', 'QQQ', 'RRR', 'SSS', 'TTT', 'UUU', 'WWW', 'XXX', 'YYY', 'ZZZ'];
        this.currentitem = {"name":"", "content": "" };
        this.currentlegend = [];
      },

      save_me: function(){
      },

      _handle_response_get: function(response){
        if ( typeof this.objid != 'undefined' && typeof response.detail.response != 'undefined'){
          console.log('Received response from GET: ', response.detail.response);
          this.currentitem = response.detail.response;
          this.currentcontent = response.detail.response.content;
          //this.currentlegend = JSON.parse(response.detail.response.legend);
          console.log('The legend got from the GET is :', this.currentlegend );
        }
      },

      _handle_response_get_template: function(response){
        if ( typeof this.objid != 'undefined' && typeof response.detail.response != 'undefined'){
          console.log('Received response from GET template : ', response.detail.response);
          this.currentpieces = JSON.parse(response.detail.response.pieces);
          this.currentcontent = "";
          this.currentlegend = [];
          var symbolsToAssign = this.lettersymbols;
          for (index = 0, len = this.currentpieces.length; index < len; ++index) {
            var currentPiece = this.currentpieces[index];
            console.log('New piece :', currentPiece );
            console.log('Now content is ', this.currentcontent );
            for (j = 0, lenLegend = currentPiece.legend.length; j < lenLegend; ++j) {
              var currentLegendItem = currentPiece.legend[j];
              console.log('New legend item is :', currentLegendItem );
              var oldSymbol = currentLegendItem.key;
              var newSymbol = symbolsToAssign[0];
              currentPiece.content = currentPiece.content.replace(oldSymbol, newSymbol);
              console.log('Updated content :', currentPiece );
              currentLegendItem.key = newSymbol;
              symbolsToAssign.shift();
              console.log('With new key it is now :', currentLegendItem );
              this.currentlegend.push(currentLegendItem);
            }
            this.currentcontent = this.currentcontent.concat(currentPiece.content);
          }
          console.log('The legend got from the GET is :', this.currentpieces );
          console.log('Current legend is now :', this.currentlegend );
        }
      },

      _handle_response_post: function(response){
        console.log('Received response from POST: ', response.detail.response);
        this.currentitem = response.detail.response;
        this.currentcontent = response.detail.response.content;
        this.currentlegend = JSON.parse(response.detail.response.legend);
        console.log('The legend got from the POST is :', this.currentlegend );
      },

      _obj_id_has_changed: function(new_value, old_value){
        console.log('ON CHANGE ID :  ', new_value);
        if ( new_value !== "new" ){
            this.$.my_iron_get.generateRequest();
        }
      },

      _obj_templ_has_changed: function(new_value, old_value){
        console.log('ON CHANGE TEMPL:  ', new_value);
        if ( new_value !== "empty" ){
            this.$.my_iron_get_template.generateRequest();
        }
      },

      computeKey:function(currentv){
        return 'Describe ' + currentv ;
      },

      computeGetUrl:function(currentId){
        var new_get_url = ( currentId === "new" ) ? '' : '/documents/' + String(this.objid);
        console.log('Computing GET URL :', new_get_url );
        return new_get_url;
      },

      computeGetUrlOfTemplate:function(currentTempl){
        var new_get_url = ( currentTempl === "empty" ) ? '' : '/categories/' + String(this.objtempl);
        console.log('Computing GET URL for template  :', new_get_url );
        return new_get_url;
      },

      computePushMethod:function(currentId){
        var new_push_method = ( currentId === "new" ) ? "POST" : "PUT";
        console.log('Computing Push method :', new_push_method );
        return new_push_method;
      },

      computePushUrl:function(currentId){
        var new_push_url = ( currentId === "new" ) ? '/documents' : '/documents/' + currentId + '/';
        console.log('Computing Push URL :', new_push_url );
        return new_push_url;
      },

      _getFromCurrentLegendOrEmpty: function(symbol_to_search){

      },

      _on_content_change: function(new_value, old_value){

      } // _on_content_change

    });
  })();
</script>
